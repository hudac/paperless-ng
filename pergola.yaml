version: v1

components:
- name: broker
  docker:
    image: redis:6.0
  ports:
  - 6379

- name: db
  docker:
    image: postgres:13
  env:
  - name: POSTGRES_DB
    value: paperless
  - name: POSTGRES_USER
    config-ref: PAPERLESS_DBUSER
  - name: POSTGRES_PASSWORD
    config-ref: PAPERLESS_DBPASS
  storage:
  - name: pgdata
    path: /var/lib/postgresql/data
    size: 2Gi
  ports:
  - 5432

- name: paperless-ng
  docker:
    file: Dockerfile
  ports:
  - 8000
  ingresses:
  - host: dashboard
  storage:
  - name: data
    path: /usr/src/paperless/data
    size: 1Gi
  - name: media
    path: /usr/src/paperless/media
    size: 1Gi
  - name: export
    path: /usr/src/paperless/export
    size: 1Gi
  - name: consume
    path: /usr/src/paperless/consume
    size: 1Gi
  env:
  - name: PAPERLESS_SECRET_KEY
    config-ref: PAPERLESS_SECRET_KEY
  - name: REDIS_HOST_REF
    component-ref: broker
  - name: PAPERLESS_REDIS
    value: "redis://$(REDIS_HOST_REF):6379"
  - name: PAPERLESS_DBHOST
    component-ref: db
  - name: PAPERLESS_DBUSER
    config-ref: PAPERLESS_DBUSER
  - name: PAPERLESS_DBPASS
    config-ref: PAPERLESS_DBPASS
  - name: PAPERLESS_TIKA_ENABLED
    value: 1
  - name: GOTENBERG_HOST_REF
    component-ref: gotenberg
  - name: PAPERLESS_TIKA_GOTENBERG_ENDPOINT
    value: "http://$(GOTENBERG_HOST_REF):3000"
  - name: TIKA_HOST_REF
    component-ref: tika
  - name: PAPERLESS_TIKA_ENDPOINT
    value: "http://$(TIKA_HOST_REF):9998"
  - name: PAPERLESS_ADMIN_USER
    config-ref: PAPERLESS_ADMIN_USER
  - name: PAPERLESS_ADMIN_PASSWORD
    config-ref: PAPERLESS_ADMIN_PASSWORD

- name: gotenberg
  docker:
    image: thecodingmachine/gotenberg:6
  env:
  - name: DISABLE_GOOGLE_CHROME
    value: 1
  ports:
  - 3000

- name: tika
  docker:
    image: apache/tika:1.28
  ports:
  - 9998
